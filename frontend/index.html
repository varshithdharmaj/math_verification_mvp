<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVM¬≤ Math Verifier</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f5f5f7; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #1d1d1f; text-align: center; margin-bottom: 2rem; }
        .input-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #444; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; }
        button { background-color: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: background 0.2s; width: 100%; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
        
        .result-box { margin-top: 2rem; border-top: 1px solid #eee; padding-top: 2rem; display: none; }
        .verdict { font-size: 1.5rem; font-weight: bold; text-align: center; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .valid { background-color: #e8f5e9; color: #2e7d32; }
        .error { background-color: #ffebee; color: #c62828; }
        
        .agent-card { border: 1px solid #eee; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafafa; }
        .agent-header { display: flex; justify-content: space-between; cursor: pointer; font-weight: bold; }
        .steps-list { margin-top: 10px; padding-left: 20px; }
        .step-item { padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; }
        .risk-high { background-color: #ffebee; border-left: 3px solid #f44336; } /* Hallucination */
        .risk-med { background-color: #fff8e1; border-left: 3px solid #ffc107; }  /* Low Consensus */
        
        .tab-buttons { display: flex; margin-bottom: 1rem; border-bottom: 1px solid #ddd; }
        .tab-btn { background: none; color: #666; padding: 10px 20px; border-bottom: 2px solid transparent; width: auto; font-weight: normal; }
        .tab-btn.active { color: #007aff; border-bottom: 2px solid #007aff; font-weight: bold; }
        
        .loading { text-align: center; color: #666; display: none; }
        code { background: #f0f0f0; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üî¢ MVM¬≤ Math Verifier</h1>
    
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('text')">Text / LaTeX</button>
        <button class="tab-btn" onclick="switchTab('image')">Image Upload</button>
    </div>

    <!-- Text Input Form -->
    <div id="text-form" class="input-section">
        <div class="input-group">
            <label>Math Problem & Solution Steps</label>
            <textarea id="text-input" rows="8" placeholder="2x + 4 = 10&#10;2x = 6&#10;x = 3"></textarea>
        </div>
        <button onclick="verifyText()">Verify Text</button>
    </div>

    <!-- Image Input Form -->
    <div id="image-form" class="input-section" style="display:none;">
        <div class="input-group">
            <label>Upload Math Image</label>
            <input type="file" id="image-input" accept="image/*">
        </div>
        <button onclick="verifyImage()">Verify Image</button>
    </div>

    <div id="loading" class="loading">
        <p>üîÑ Processing... Running multi-agent verification...</p>
    </div>

    <div id="result-box" class="result-box">
        <div id="verdict-banner" class="verdict"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <h3>üìù Input Analysis</h3>
                <p><strong>OCR/Input Confidence:</strong> <span id="ocr-conf">-</span></p>
                <p><strong>Canonical Form:</strong> <br><code id="canonical-prob"></code></p>
            </div>
            <div>
                <h3>ü§ñ Final Decision</h3>
                <p><strong>Chosen Agent:</strong> <span id="chosen-agent">-</span></p>
                <p><strong>Confidence:</strong> <span id="final-conf">-</span></p>
            </div>
        </div>
        
        <div class="note" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>üë®‚Äçüè´ Teacher's Explanation:</strong>
            <p id="teacher-explanation" style="margin-top: 5px; white-space: pre-wrap;"></p>
        </div>

        <h3>üîç Detailed Agent Analysis</h3>
        <div id="agents-container"></div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8000";

    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.input-section').forEach(d => d.style.display = 'none');
        
        if (mode === 'text') {
            document.getElementById('text-form').style.display = 'block';
            document.querySelector('.tab-btn:first-child').classList.add('active');
        } else {
            document.getElementById('image-form').style.display = 'block';
            document.querySelector('.tab-btn:last-child').classList.add('active');
        }
    }

    async function verifyText() {
        const text = document.getElementById('text-input').value;
        if (!text) return alert("Please enter text");
        
        callApi(`${API_BASE}/solve/text`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text, metadata: {}})
        });
    }

    async function verifyImage() {
        const fileInput = document.getElementById('image-input');
        if (!fileInput.files[0]) return alert("Please select an image");
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('metadata_json', JSON.stringify({source: 'web_upload'}));
        
        callApi(`${API_BASE}/solve/image`, {
            method: 'POST',
            body: formData
        });
    }

    async function callApi(url, options) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result-box').style.display = 'none';
        
        try {
            const res = await fetch(url, options);
            const data = await res.json();
            renderResults(data);
        } catch (e) {
            alert("Error calling backend: " + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderResults(data) {
        const box = document.getElementById('result-box');
        box.style.display = 'block';
        
        // Verdict
        const decision = data.final_decision;
        const banner = document.getElementById('verdict-banner');
        banner.textContent = `${decision.verdict} (${(decision.confidence * 100).toFixed(1)}%)`;
        banner.className = `verdict ${decision.verdict === 'VALID' ? 'valid' : 'error'}`;
        
        // Metrics
        document.getElementById('ocr-conf').textContent = (data.input.ocr_confidence * 100).toFixed(1) + '%';
        document.getElementById('canonical-prob').textContent = data.canonical_representation.problem_latex || "(No structured problem)";
        document.getElementById('chosen-agent').textContent = decision.chosen_agent;
        document.getElementById('final-conf').textContent = decision.confidence.toFixed(3);
        document.getElementById('teacher-explanation').textContent = decision.teacher_explanation;
        
        // Agents
        const agentsDiv = document.getElementById('agents-container');
        agentsDiv.innerHTML = '';
        
        data.multi_agent_analysis.forEach(agent => {
            const card = document.createElement('div');
            card.className = 'agent-card';
            
            // Build steps HTML
            let stepsHtml = '';
            agent.steps_analysis.forEach((step, idx) => {
                const riskClass = step.is_hallucination_risk ? 'risk-high' : (step.consensus_score < 0.7 ? 'risk-med' : '');
                const riskLabel = step.is_hallucination_risk ? '<span style="color:red; font-size:0.8em">‚ö† Hallucination Risk</span>' : '';
                
                stepsHtml += `
                    <div class="step-item ${riskClass}">
                        <strong>${idx+1}.</strong> ${step.step_content}
                        <div style="font-size: 0.8em; color: #666;">
                            Consensus: ${(step.consensus_score * 100).toFixed(0)}% ${riskLabel}
                        </div>
                    </div>`;
            });
            
            card.innerHTML = `
                <div class="agent-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
                    <span>${agent.agent_name} (${agent.metrics.total_score.toFixed(2)})</span>
                    <span>${agent.final_answer || 'No Answer'}</span>
                </div>
                <div class="steps-list">
                    ${stepsHtml || '<p>No steps provided</p>'}
                    <div style="margin-top: 10px; font-size: 0.85em; background: #eee; padding: 5px; border-radius: 4px;">
                        Scores: Sym=${agent.metrics.symbolic_score.toFixed(2)}, Log=${agent.metrics.logical_score.toFixed(2)}, Clf=${agent.metrics.clf_score.toFixed(2)}
                    </div>
                </div>
            `;
            agentsDiv.appendChild(card);
        });
    }
</script>

</body>
</html>
